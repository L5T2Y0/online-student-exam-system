# 更新日志

## [1.1.1] - 2026-02-17 - Bug修复与数据增强

### 🐛 Bug 修复
- **组卷总分计算**: 
  - 修正表单初始值，新建试卷时总分从100改为0，避免误导
  - 修正测试数据中试卷总分与题目分数不匹配的问题
  - 总分现在正确地自动计算为所有题目分数之和
  - 已修复数据库中现有试卷的总分

### ✨ 数据增强
- **用户数据**: 学生数量从10个增加到20个
- **题目数据**: 题目数量从13道增加到27道
  - 新增6道单选题（涵盖更多知识点）
  - 新增2道多选题（编程语言、数据结构）
  - 新增3道判断题（网络、数据库、编程）
  - 新增2道填空题（算法、编程语言）
  - 新增1道简答题（哈希表）
- **试卷数据**: 试卷数量从2份增加到5份
  - 计算机基础综合测试（已发布）
  - 数据结构专项测试（已发布）
  - 计算机网络基础（已发布，新增）
  - 数据库原理与应用（已发布，新增）
  - 编程语言基础（草稿，新增）
- **科目覆盖**: 新增编程语言、算法科目

## [1.1.0] - 2026-02-17 - 安全加固版本

### 🔒 安全修复

#### 严重
- **JWT 密钥强制验证**: 服务器启动时检查 JWT_SECRET，未配置则拒绝启动
- **CORS 白名单**: 限制跨域请求来源，通过环境变量配置
- **请求频率限制**: 全局限制 + 登录/注册严格限制，防止暴力破解
- **XSS 防护**: 对用户输入进行清理，防止脚本注入
- **环境变量验证**: 启动时验证必需的环境变量

### 🐛 Bug 修复

#### 高优先级
- **权限检查增强**: 
  - 学生只能查看已发布试卷
  - 教师只能查看自己创建的草稿或已发布试卷
  - 试卷列表接口添加权限过滤
  
- **考试提交竞态条件**: 
  - 使用数据库事务和行锁
  - 防止重复提交
  - 明确状态检查
  
- **Token 过期处理**: 
  - 401 响应时触发全局登出事件
  - 清理前端认证状态
  - 避免重复跳转

- **输入验证增强**:
  - 试卷总分和时长必须大于0
  - 时间窗口验证（开始时间 < 结束时间）
  - 分页参数验证和限制（最大100）
  - 批量操作数量限制

- **文件上传安全**:
  - 文件大小限制（5MB）
  - 文件类型验证（只允许 Excel）
  - 导入数量限制（最多500条）

- **防止误删**: 
  - 管理员不能删除自己的账户
  - 批量删除时跳过当前用户

- **请求体大小限制**: 限制为 10MB

### ✨ 新增功能

- **环境变量模板**: 添加 `.env.example` 文件
- **修复文档**: 
  - `README_FIXES.md` - 快速开始指南
  - `SECURITY_FIXES.md` - 详细安全修复文档
  - `CHANGELOG.md` - 修复日志

### 📦 依赖更新

新增依赖:
- `express-rate-limit` - 请求频率限制
- `xss` - XSS 防护

### 🔧 配置变更

新增环境变量:
- `JWT_SECRET` - JWT 密钥（必需）
- `ALLOWED_ORIGINS` - CORS 白名单（可选，默认 localhost:3000）

### 📝 文件变更

#### 修改的文件
- `server/middleware/auth.js` - JWT 密钥验证
- `server/index.js` - CORS、频率限制、环境变量验证
- `server/routes/auth.js` - XSS 清理
- `server/routes/exams.js` - 事务、分页验证
- `server/routes/papers.js` - 权限检查、输入验证
- `server/routes/users.js` - 分页验证、文件上传安全、防止误删
- `client/src/utils/api.js` - Token 过期处理
- `client/src/contexts/AuthContext.js` - 监听登出事件
- `package.json` - 新增依赖

#### 新增的文件
- `.env.example` - 环境变量模板
- `README_FIXES.md` - 修复说明
- `SECURITY_FIXES.md` - 安全修复详情
- `CHANGELOG.md` - 修复日志

### ⚠️ 破坏性变更

1. **必须配置 JWT_SECRET**: 服务器启动时会检查，未配置将拒绝启动
2. **CORS 限制**: 默认只允许 localhost:3000，其他来源需要配置
3. **频率限制**: 登录/注册 15 分钟内最多 10 次尝试

### 🚀 升级步骤

1. 安装新依赖:
   ```bash
   npm install
   ```

2. 配置环境变量:
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，设置 JWT_SECRET 等
   ```

3. 生成 JWT 密钥:
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

4. 重启服务器:
   ```bash
   npm run dev
   ```

### 📊 修复统计

- 严重安全问题: 5 个 ✅
- 高优先级 Bug: 7 个 ✅
- 代码改进: 多处
- 新增文档: 3 个
- 新增依赖: 2 个

### 🔜 待改进（未来版本）

#### 中等优先级
- Token 黑名单或版本控制（密码修改后使旧 Token 失效）
- 审计日志系统
- 离线支持（考试数据本地缓存）
- React 错误边界

#### 低优先级
- API 文档（Swagger）
- 监控和告警系统
- 代码重构（提取公共中间件）
- 单元测试和集成测试

---

## [1.0.0] - 初始版本

### ✨ 核心功能
- 用户管理（学生、教师、管理员）
- 题库管理（单选、多选、判断、填空、简答）
- 试卷管理（手动组卷、自动组卷）
- 在线考试（倒计时、防作弊监控）
- 自动评分（客观题）
- 成绩统计和分析
- 批量导入导出（Excel）

### 🛠️ 技术栈
- 前端：React + Ant Design + React Router
- 后端：Node.js + Express + Sequelize
- 数据库：MySQL
- 认证：JWT
